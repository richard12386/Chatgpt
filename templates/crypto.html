<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crypto Hub</title>
  <style>
    :root {
      --bg-1: #fff7ed;
      --bg-2: #ecfeff;
      --ink: #162029;
      --muted: #5f6b76;
      --panel: rgba(255, 255, 255, 0.92);
      --line: #d9dee4;
      --accent: #0284c7;
      --danger: #b42318;
      --up: #0f766e;
      --down: #dc2626;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--ink);
      font-family: "Avenir Next", "Segoe UI", "Trebuchet MS", sans-serif;
      background:
        radial-gradient(circle at 10% 20%, #fde68a 0%, transparent 35%),
        radial-gradient(circle at 85% 10%, #bae6fd 0%, transparent 40%),
        linear-gradient(140deg, var(--bg-1), var(--bg-2));
      min-height: 100vh;
    }
    .page {
      max-width: 1080px;
      margin: 0 auto;
      padding: 1.4rem 1rem 2.5rem;
    }
    .topnav {
      margin-bottom: 0.75rem;
      border-bottom: 2px solid #0891b2;
      padding-bottom: 0.35rem;
      display: flex;
      gap: 0.45rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .topnav a {
      border: 1px solid #bae6fd;
      color: #0c4a6e;
      background: #ecfeff;
      text-decoration: none;
      font-weight: 800;
      padding: 0.44rem 0.7rem;
      border-radius: 8px;
      display: inline-block;
    }
    .topnav a.active {
      background: #dbeafe;
      color: #1e3a8a;
      border-color: #93c5fd;
    }
    .topnav .ghost {
      background: #f8fafc;
      color: #334155;
      border: 1px solid #dbe2ea;
    }
    .topnav .user-pill {
      background: #f8fafc;
      color: #334155;
      border: 1px solid #dbe2ea;
      border-radius: 8px;
      padding: 0.44rem 0.7rem;
      font-weight: 800;
      font-size: 0.9rem;
    }
    .topnav .spacer { flex: 1; }
    .inline-form { margin: 0; display: inline; }
    .logout-btn {
      border: 1px solid #dbe2ea;
      color: #334155;
      background: #f8fafc;
      border-radius: 8px;
      padding: 0.44rem 0.7rem;
      font-weight: 800;
      cursor: pointer;
    }
    .hero, .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: 0 10px 24px rgba(22, 32, 41, 0.08);
      padding: 0.95rem;
    }
    h1 { margin: 0 0 0.2rem; }
    .lead { margin: 0; color: var(--muted); }
    .query-form {
      margin-top: 0.8rem;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.55rem;
      align-items: center;
    }
    input[type="text"] {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
      padding: 0.72rem 0.8rem;
      font-size: 0.98rem;
      color: var(--ink);
    }
    button {
      border: 0;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), #0ea5e9);
      color: #fff;
      font-weight: 700;
      padding: 0.72rem 1rem;
      cursor: pointer;
    }
    .error {
      margin-top: 0.85rem;
      color: var(--danger);
      background: #fef3f2;
      border: 1px solid #fecdca;
      border-radius: 12px;
      padding: 0.7rem 0.8rem;
    }
    .results {
      margin-top: 0.95rem;
      display: grid;
      gap: 0.9rem;
    }
    .head-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.8rem;
      flex-wrap: wrap;
    }
    .coin-title {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 900;
    }
    .price {
      margin: 0.16rem 0 0;
      font-size: 1.55rem;
      font-weight: 900;
    }
    .change {
      margin: 0.2rem 0 0;
      font-size: 0.9rem;
      font-weight: 800;
    }
    .change.up { color: var(--up); }
    .change.down { color: var(--down); }
    .range-row {
      display: inline-flex;
      gap: 0.35rem;
      padding: 0.3rem;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #f8fafc;
      flex-wrap: wrap;
    }
    .range-btn {
      border: 1px solid #dbe2ea;
      background: #fff;
      color: #334155;
      border-radius: 8px;
      padding: 0.3rem 0.52rem;
      font-size: 0.82rem;
      font-weight: 800;
      cursor: pointer;
      line-height: 1;
    }
    .range-btn.active {
      background: #dbeafe;
      border-color: #93c5fd;
      color: #1e3a8a;
    }
    .chart-wrap {
      height: 430px;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 0.6rem;
    }
    .subtle {
      margin: 0.35rem 0 0;
      color: var(--muted);
      font-size: 0.84rem;
    }
    .hover-readout {
      margin-top: 0.25rem;
      font-weight: 700;
      color: #0c4a6e;
      min-height: 1.2em;
    }
    @media (max-width: 650px) {
      .query-form { grid-template-columns: 1fr; }
      .chart-wrap { height: 320px; }
    }
  </style>
</head>
<body>
  <main class="page">
    <nav class="topnav" aria-label="Primary">
      <a href="/">Stocks</a>
      <a class="active" href="/crypto">Crypto</a>
      <a href="/crypto/markets">Crypto Markets</a>
      {% if current_user %}
        <span class="user-pill">User: {{ current_user.username }}</span>
        <div class="spacer"></div>
        <form class="inline-form" method="post" action="/logout">
          <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
          <button class="logout-btn" type="submit">Logout</button>
        </form>
      {% else %}
        <div class="spacer"></div>
        <a class="ghost" href="/login">Login</a>
        <a class="ghost" href="/register">Register</a>
      {% endif %}
    </nav>

    <section class="hero">
      <h1>Crypto Hub</h1>
      <p class="lead">Type symbol or full coin name (e.g. BTC, ETH, Solana, Cardano) to load live chart.</p>
      <form class="query-form" method="post">
        <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
        <input type="text" name="symbol" value="{{ input_value }}" placeholder="e.g. BTC or Bitcoin" required>
        <button type="submit">Load Chart</button>
      </form>
    </section>

    {% if error %}
      <div class="error">{{ error }}</div>
    {% endif %}

    {% if result %}
    <section class="results">
      <article class="card">
        <div class="head-row">
          <div>
            <p class="coin-title">{{ result.name }} ({{ result.display_symbol }})</p>
            <p class="price">{% if result.current_price_usd is not none %}${{ "%.6f"|format(result.current_price_usd) }}{% else %}N/A{% endif %}</p>
            {% if result.change_pct is not none %}
              <p class="change {% if result.change_pct >= 0 %}up{% else %}down{% endif %}">
                {{ "%.2f"|format(result.change_pct) }}%
              </p>
            {% endif %}
          </div>
          <form method="get" class="range-row">
            <input type="hidden" name="symbol" value="{{ result.symbol }}">
            <input type="hidden" name="log_scale" value="{{ log_scale }}">
            {% for value, label in range_options %}
              <button class="range-btn {% if selected_range == value %}active{% endif %}" name="range" value="{{ value }}" type="submit">{{ label }}</button>
            {% endfor %}
            <button class="range-btn {% if log_scale == '1' %}active{% endif %}" type="submit" name="log_scale" value="{% if log_scale == '1' %}0{% else %}1{% endif %}">Log</button>
          </form>
        </div>
        <p class="subtle">Chart source: Yahoo Finance | Price validation sources: CoinMarketCap, Yahoo, CoinGecko API, Binance API | As of {{ result.as_of }}</p>
        <p id="hoverReadout" class="hover-readout">Move mouse over the chart to see live price.</p>
      </article>

      <article class="card">
        <div class="chart-wrap">
          <canvas id="cryptoChart"></canvas>
        </div>
      </article>
    </section>
    {% endif %}
  </main>

  {% if result %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const points = {{ result.points|tojson }};
    const labels = points.map((p) => p.label);
    const prices = points.map((p) => p.price);
    const hoverReadout = document.getElementById("hoverReadout");
    const up = {{ "true" if (result.change_pct is not none and result.change_pct >= 0) else "false" }};
    const lineColor = up ? "#16a34a" : "#ef4444";

    function formatUsd(value) {
      if (!Number.isFinite(value)) return "N/A";
      return "$" + value.toFixed(6);
    }

    function interpolateAtX(chart, pixelX) {
      if (!prices.length) return null;
      if (prices.length === 1) {
        return { price: prices[0], indexFloat: 0, label: labels[0] || "" };
      }
      const xScale = chart.scales.x;
      const firstX = xScale.getPixelForValue(0);
      const lastX = xScale.getPixelForValue(prices.length - 1);
      if (lastX <= firstX) return null;

      const clamped = Math.max(firstX, Math.min(lastX, pixelX));
      const ratio = (clamped - firstX) / (lastX - firstX);
      const indexFloat = ratio * (prices.length - 1);
      const i0 = Math.floor(indexFloat);
      const i1 = Math.min(prices.length - 1, i0 + 1);
      const t = indexFloat - i0;
      const p0 = Number(prices[i0]);
      const p1 = Number(prices[i1]);
      const interp = p0 + (p1 - p0) * t;
      const nearestLabel = labels[Math.round(indexFloat)] || "";
      return { price: interp, indexFloat, label: nearestLabel };
    }

    const crosshairPlugin = {
      id: "crosshairPlugin",
      afterDatasetsDraw(chart) {
        if (!Number.isFinite(chart.$hoverX)) return;
        const { ctx, chartArea } = chart;
        if (!chartArea) return;
        const x = Math.max(chartArea.left, Math.min(chartArea.right, chart.$hoverX));
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(x, chartArea.top);
        ctx.lineTo(x, chartArea.bottom);
        ctx.lineWidth = 1;
        ctx.strokeStyle = "rgba(14, 116, 144, 0.45)";
        ctx.stroke();
        ctx.restore();
      },
    };

    const ctx = document.getElementById("cryptoChart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "{{ result.display_symbol }}",
          data: prices,
          borderColor: lineColor,
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.2,
          fill: true,
          backgroundColor: up ? "rgba(34,197,94,0.12)" : "rgba(239,68,68,0.12)",
        }]
      },
      options: {
        maintainAspectRatio: false,
        animation: { duration: 450 },
        interaction: {
          mode: "index",
          intersect: false
        },
        onHover: (event, _active, chart) => {
          const native = event && event.native;
          if (!native) return;
          const hit = interpolateAtX(chart, native.offsetX);
          if (!hit) return;
          chart.$hoverX = native.offsetX;
          hoverReadout.textContent = `${hit.label} | ${formatUsd(hit.price)}`;
          chart.draw();
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            intersect: false,
            callbacks: {
              label: function(context) {
                return "$" + Number(context.raw).toFixed(6);
              }
            }
          }
        },
        scales: {
          x: { ticks: { maxTicksLimit: 8 } },
          y: {
            type: "{{ 'logarithmic' if log_scale == '1' else 'linear' }}",
            beginAtZero: false
          }
        }
      },
      plugins: [crosshairPlugin]
    });

    const canvas = document.getElementById("cryptoChart");
    canvas.addEventListener("mouseleave", () => {
      hoverReadout.textContent = "Move mouse over the chart to see live price.";
    });
  </script>
  {% endif %}
</body>
</html>
